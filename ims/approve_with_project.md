# 项目与审批流程关联测试


## 1. 测试准备

审批流程添加
```
用超管进入：系统管理 → 审批流程配置
新增一个流程：项目创建审批流
节点1：项目管理员审批
节点2：安全/运维审批（可选，但建议加上，方便验证多节点）

在“项目管理/项目创建”相关配置里（你的实现里可能是：项目类型、动作、或系统配置项）完成绑定：

绑定规则建议：(对象=项目, 动作=create) → 审批流=项目创建审批流
这样才能验证“创建项目后流程自动走到哪里”。

✅ 预期：之后任何人点“新建项目→提交”，系统会自动生成一条项目审批实例（而不是只创建项目记录）。
```

准备测试账号:
```
准备3类测试账号（最少）
这一步是为了验证“谁能看到/谁能审批/谁能推进”。
A：普通用户（业务方/承建方）——用于“发起项目”
contractor
B：审批人1（项目管理员角色或具备审批权限的人）——用于“节点1审批”
project_admin
C：审批人2（运维/安全角色）——用于“节点2审批”
operation_staff
S：超级管理员（可选）——用于“看全局与兜底”
admin
（角色与权限、项目隔离、审批相关权限在需求里都有强调。
```

## 2. 测试流程
Step 1：A 发起“新建项目”
路径：项目管理 → 新建项目
按你文档的字段填：
项目名称、编码、描述
业务部门、最终用户、预计上线时间
选择基础镜像版本、选择组件（如果你已经做了这些入口）
提交
✅ 预期（关键点）：
项目状态不是“已生效”，而是类似：待审批 / 审批中
系统生成“流程实例”：当前节点=节点1（项目管理员审批）

Step 2：B 登录，查看“我的待办审批”

路径建议：审批中心 / 待我审批 / 项目审批

✅ 预期：

B 能看到 A 刚提交的项目审批单

其他无审批权限用户看不到（验证权限隔离）

操作：B 点击审批单 → 通过

✅ 预期（流程自动推进）：

项目审批实例流转到 节点2（运维/安全）

项目状态仍为 审批中，但“当前节点/当前阶段”发生变化

系统给 A 发通知：“节点1已通过”（你文档有通知模块关键阶段推送）。

RequirementsDocument_V1.0_mod

Step 3：C 登录，完成节点2审批

C 打开待办 → 找到该项目 → 通过

✅ 预期（最终生效）：

流程实例状态 = 完成

项目状态 = 已创建/已启用/已生效（你系统用哪个枚举都行，但要有“最终态”）

A 收到“项目创建成功”的通知

项目进入“可进行后续操作”的状态：比如可以开始“业务镜像入库/检测/成员管理”等（你文档的项目后续流程）。

RequirementsDocument_V1.0_mod

3. “下一步做什么”的自动规则（你按这个验收）

当项目审批完成后，你的系统至少要满足这条自动逻辑：

项目未审批完成：

禁止发起“业务镜像入库申请 / 检测申请”等需要项目有效性的动作

只能做“查看进度 / 撤销申请（可选）/ 修改草稿（可选）”

项目审批完成：

开放项目内功能：成员管理、检测工具配置、业务镜像流程等

所有资源自动带 project_id 并按权限过滤（你文档强调项目隔离）。

RequirementsDocument_V1.0_mod

4. 怎么样才算“完成”（验收口径）

把“完成”定义清楚，测试就不会打架：

项目创建审批流的完成 = 满足以下全部条件：

审批实例状态为 完成

项目状态为 生效/启用（而不是仍显示待审批）

项目详情页显示“全部节点已完成”，并能追溯审批记录（谁、何时、意见）

项目后续能力解锁：至少能进入“项目成员管理”或“业务镜像入库申请”入口

通知到达：发起人 A 收到“项目创建成功/审批通过”通知

5. 必测的2条反向用例（非常关键）
用例A：节点1拒绝

B 拒绝项目
✅ 预期：

流程实例状态 已拒绝

项目状态 已拒绝/已驳回

A 收到驳回通知与理由

不允许进入后续动作（入库/检测等）

用例B：A 撤销申请（如果你要支持）

A 在“审批中”撤销
✅ 预期：

流程实例 已撤销

项目回到 草稿/已撤销（你自己定）

B/C 待办中消失

6. 你按这套做开发收尾时，最容易漏的点（直接当 checklist）

 审批流程实例里必须保存：object_type=项目、object_id=project.id、action=create

 项目表必须有 approve_status/current_step 或可推导字段（用于列表与详情展示）

 待办查询必须按“节点审批人范围”过滤（不是所有人都看得到）

 项目权限隔离：非项目成员看不到项目/看不到资源（除超管）

RequirementsDocument_V1.0_mod

 审批通过触发“状态切换 + 通知”

如果你愿意，我可以按你现在 Django 工程的结构（projects、system、rbac、notification 等）把上面这套测试步骤映射成你系统里的实际页面/接口清单（比如“点哪个菜单、调用哪个URL、数据库里哪张表应新增一行、状态字段具体是什么”），你直接照着一步一步点就能验收通过。